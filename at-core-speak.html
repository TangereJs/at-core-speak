<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-theme/at-theme.html" />
<link rel="import" href="../at-carbon-icon-button/at-carbon-icon-button.html" />

<dom-module id="at-core-speak">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }
    </style>
    
    <div hidden$="[[supported]]">Speach synthesis is not supported by this browser</div>
    
    <at-carbon-icon-button hidden$="[[!_computePlayButtonVisible(supported, mode)]]" icon="now:play" on-tap="_handlePlayButtonOnTap"></at-carbon-icon-button>

  </template>
</dom-module>
<script>
  Polymer({
    is: "at-core-speak",
    properties: {

      value: {
        type: String,
        value: '',
        xtype: 'code',
        mode: 'ssml',
        xgridcols: "12",
        observer: '_valueChanged'
      },

      mode: {
        type: String,
        value: "auto",
        xtype: 'enum',
        enum: [ 'auto', 'play', 'button' ]
      },

      supported: {
        type: Boolean,
        value: false,
        readOnly: true
      }
    },

    _computePlayButtonVisible: function(supported, mode) {
      return supported && mode === "button";
    },

    ready: function () {
      this._setSupported(!!window.speechSynthesis);

      if (!this.supported) {
        return;
      }
    },

    _valueChanged: function(newValue, oldValue) {
      // validate newValue
      if (!this._isString(newValue)) return;

      if (this.mode === "auto") {
        this.play();
      }
    },

    _isString: function(obj) {
      return Object.prototype.toString.apply(obj) === "[object String]";
    },

    play: function() {
      if (!this.value) return;

      var ut = new SpeechSynthesisUtterance(this.value);

      // SpeechSynthesisUtterance.lang
      // Gets and sets the language of the utterance.
      // SpeechSynthesisUtterance.pitch
      // Gets and sets the pitch at which the utterance will be spoken at.
      // SpeechSynthesisUtterance.rate
      // Gets and sets the speed at which the utterance will be spoken at.
      // SpeechSynthesisUtterance.text
      // Gets and sets the text that will be synthesised when the utterance is spoken.
      // SpeechSynthesisUtterance.voice
      // Gets and sets the voice that will be used to speak the utterance.
      // SpeechSynthesisUtterance.volume
      // Gets and sets the volume that the utterance will be spoken at.

      // SpeechSynthesisUtterance.onboundary
      // Fired when the spoken utterance reaches a word or sentence boundary.
      // SpeechSynthesisUtterance.onend
      // Fired when the utterance has finished being spoken.
      // SpeechSynthesisUtterance.onerror
      // Fired when an error occurs that prevents the utterance from being succesfully spoken.
      // SpeechSynthesisUtterance.onmark
      // Fired when the spoken utterance reaches a named SSML "mark" tag.
      // SpeechSynthesisUtterance.onpause
      // Fired when the utterance is paused part way through.
      // SpeechSynthesisUtterance.onresume
      // Fired when a paused utterance is resumed.
      // SpeechSynthesisUtterance.onstart
      // Fired when the utterance has begun to be spoken.
      
      window.speechSynthesis.speak(ut);
    },

    _handlePlayButtonOnTap: function(event) {
      this.play();
    }
  });
</script>
