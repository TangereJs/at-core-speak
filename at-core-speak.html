<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-theme/at-theme.html" />
<link rel="import" href="../at-carbon-icon-button/at-carbon-icon-button.html" />

<dom-module id="at-core-speak">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }
    </style>
    
    <div hidden$="[[supported]]">Speach synthesis is not supported by this browser</div>
    
    <at-carbon-icon-button hidden$="[[!_computePlayButtonVisible(supported, mode)]]" disabled$="[[_inProgress]]" icon="now:play" on-tap="_handlePlayButtonOnTap"></at-carbon-icon-button>

  </template>
</dom-module>
<script>
  Polymer({
    is: "at-core-speak",
    properties: {

      value: {
        type: String,
        value: '',
        xtype: 'code',
        mode: 'ssml',
        xgridcols: "12",
        observer: '_valueChanged'
      },

      mode: {
        type: String,
        value: "auto",
        xtype: 'enum',
        xvaluelist: [ 
          { title: 'auto', value: 'auto' },
          { title: 'play', value: 'play' },
          { title: 'button', value: 'button' }
        ]
      },

      supported: {
        type: Boolean,
        value: false,
        readOnly: true
      },

      // TODO: should this be public ??? 
      _inProgress: {
        type: Boolean,
        value: false,
        readOnly: true
      },

    },

    _computePlayButtonVisible: function(supported, mode) {
      return supported && mode === "button";
    },

    ready: function () {
      this._setSupported(!!window.speechSynthesis);

      if (!this.supported) {
        return;
      }
    },

    _valueChanged: function(newValue, oldValue) {
      // validate newValue
      if (!this._isString(newValue)) return;

      if (this.mode === "auto") {
        this.play();
      }
    },

    _isString: function(obj) {
      return Object.prototype.toString.apply(obj) === "[object String]";
    },

    play: function() {
      if (!this.value) return;

      if (this._inProgress) return;

      var ut = new SpeechSynthesisUtterance(this.value);

      // Ref material
      // https://developer.mozilla.org/en-US/docs/Web/API/SpeechSynthesis
      // https://developer.mozilla.org/en-US/docs/Web/API/SpeechSynthesisUtterance

      if (!this._boundOnStartHandler) {
        this._boundOnStartHandler = this._handleUtteranceOnStart.bind(this);
      }
      ut.onstart = this._boundOnStartHandler;

      if(!this._boundOnEndHandler) {
        this._boundOnEndHandler = this._handleUtteranceOnEnd.bind(this);
      }
      ut.onend = this._boundOnEndHandler;

      if (!this._boundOnErrorHandler) {
        this._boundOnErrorHandler = this._handleUtteranceOnError.bind(this);
      }
      ut.onerror = this._boundOnErrorHandler;

      window.speechSynthesis.speak(ut);
    },

    _handlePlayButtonOnTap: function(event) {
      this.play();
    },

    _handleUtteranceOnStart: function(event) {
      this._set_inProgress(true);
    },

    _handleUtteranceOnEnd: function(event) {
      this._set_inProgress(false);
    },

    _handleUtteranceOnError: function(event) {
      this._set_inProgress(false);
    },

  });
</script>
